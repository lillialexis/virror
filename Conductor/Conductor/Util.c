//
// Created by Lilli Szafranski on 2/28/16.
//

#include <math.h>
#include <sys/time.h>
#include "Util.h"

double slat(double l) { return (l > M_PI / 2.0 ? ((l - (M_PI / 2.0)) * -1.0) : ((M_PI / 2.0) - l)); }
double slon(double l) { return (l > M_PI ? (M_2X_PI - l) * -1.0 : l < (M_PI * -1.0) ? (M_2X_PI + l) : l); }

double plat(double l) { return (l < 0 ? ((l * -1.0) + (M_PI / 2.0)) : (M_PI / 2.0) - l); }
double plon(double l) { return (l < 0 ? M_2X_PI + l : l); }

int getRandomCurveHigh(int min, int max)
{
    int random = getRandom(0, (max - min) * (max - min));

    return (int)ceil(sqrt(random)) + min;
}

int getRandomCurveLow(int min, int max)
{
    int random = getRandom(0, (max - min) * (max - min));

    return ((max - min) - (int)ceil(sqrt(random))) + min;
}

int getRandomCurveMid(int min, int max)
{
    return getRandom(min, max);

    // TODO
    int squareDiff = 100;//(max - min) * (max - min);
    int random = max * max;//getRandom(0, squareDiff);

    if (random > squareDiff / 2)
        return ((max - min) - (int)ceil(sqrt(random - (squareDiff / 2))) + (int)ceil(sqrt(squareDiff / 2))) + min;

    return (int)ceil(sqrt(random)) + min;
}

int getRandom(int min, int max)
{
    if (min > max)
        return getRandom(max, min);

//#define GOOD_RANDOM
#ifdef NOT_RASPI
    return min + arc4random_uniform((u_int32_t)(max + 1 - min));
#else
    static BOOL here = NO;
    if (!here) srandom(time(NULL));
    here = YES;
    return min + (rand() % (max + 1 - min));
#endif
}

RGB hsvToRgb(HSV hsv)//, RGB rgb)
{
    RGB rgb;
    unsigned char region, p, q, t;
    unsigned int h, s, v, remainder;

    if (hsv.s == 0)
    {
        rgb.r = hsv.v;
        rgb.g = hsv.v;
        rgb.b = hsv.v;

        return rgb;
    }

    // converting to 16 bit to prevent overflow
    h = hsv.h;
    s = hsv.s;
    v = hsv.v;

    region = h / 43;
    remainder = (h - (region * 43)) * 6;

    p = (v * (255 - s)) >> 8;
    q = (v * (255 - ((s * remainder) >> 8))) >> 8;
    t = (v * (255 - ((s * (255 - remainder)) >> 8))) >> 8;

    switch (region)
    {
        case 0:
            rgb.r = v;
            rgb.g = t;
            rgb.b = p;
            break;

        case 1:
            rgb.r = q;
            rgb.g = v;
            rgb.b = p;
            break;

        case 2:
            rgb.r = p;
            rgb.g = v;
            rgb.b = t;
            break;

        case 3:
            rgb.r = p;
            rgb.g = q;
            rgb.b = v;
            break;

        case 4:
            rgb.r = t;
            rgb.g = p;
            rgb.b = v;
            break;

        default:
            rgb.r = v;
            rgb.g = p;
            rgb.b = q;
            break;
    }

    return rgb;
}

HSV rgbToHsv(RGB rgb)
{
    HSV hsv;
    unsigned char rgbMin, rgbMax;

    rgbMin = rgb.r < rgb.g ? (rgb.r < rgb.b ? rgb.r : rgb.b) : (rgb.g < rgb.b ? rgb.g : rgb.b);
    rgbMax = rgb.r > rgb.g ? (rgb.r > rgb.b ? rgb.r : rgb.b) : (rgb.g > rgb.b ? rgb.g : rgb.b);

    hsv.v = rgbMax;
    if (hsv.v == 0)
    {
        hsv.h = 0;
        hsv.s = 0;
        return hsv;
    }

    hsv.s = 255 * (long)(rgbMax - rgbMin) / hsv.v;
    if (hsv.s == 0)
    {
        hsv.h = 0;
        return hsv;
    }

    if (rgbMax == rgb.r)
        hsv.h = 0 + 43 * (rgb.g - rgb.b) / (rgbMax - rgbMin);
    else if (rgbMax == rgb.g)
        hsv.h = 85 + 43 * (rgb.b - rgb.r) / (rgbMax - rgbMin);
    else
        hsv.h = 171 + 43 * (rgb.r - rgb.g) / (rgbMax - rgbMin);

    return hsv;
}

BOOL areEqualHsv(HSV hsv1, HSV hsv2)
{
    return
            (hsv1.h == hsv2.h) &&
                    (hsv1.s == hsv2.s) &&
                    (hsv1.v == hsv2.v);
}

BOOL areEqualRgb(RGB rgb1, RGB rgb2)
{
    return
            (rgb1.r == rgb2.r) &&
                    (rgb1.g == rgb2.g) &&
                    (rgb1.b == rgb2.b);
}

long currentTimeInMicroseconds()
{
    struct timeval time;
    gettimeofday(&time, NULL);
    long micros = (time.tv_sec * 1000000) + (time.tv_usec);

    return micros;
}

#define SIN_LOOKUP_TABLE_MAX_SIZE 629
double sin_lookup_table[SIN_LOOKUP_TABLE_MAX_SIZE] = {
        0.00000, 0.01000, 0.02000, 0.03000, 0.03999, 0.04998, 0.05996, 0.06994, 0.07991, 0.08988, 0.09983, 0.10978, 0.11971, 0.12963, 0.13954, 0.14944, 0.15932, 0.16918, 0.17903, 0.18886, 0.19867, 0.20846, 0.21823, 0.22798, 0.23770, 0.24740, 0.25708, 0.26673, 0.27636, 0.28595, 0.29552, 0.30506, 0.31457, 0.32404, 0.33349, 0.34290, 0.35227, 0.36162, 0.37092, 0.38019, 0.38942, 0.39861, 0.40776, 0.41687, 0.42594, 0.43497, 0.44395, 0.45289, 0.46178, 0.47063, 0.47943, 0.48818, 0.49688, 0.50553, 0.51414, 0.52269, 0.53119, 0.53963, 0.54802, 0.55636, 0.56464, 0.57287, 0.58104, 0.58914, 0.59720, 0.60519, 0.61312, 0.62099, 0.62879, 0.63654, 0.64422, 0.65183, 0.65938, 0.66687, 0.67429, 0.68164, 0.68892, 0.69614, 0.70328, 0.71035, 0.71736, 0.72429, 0.73115, 0.73793, 0.74464, 0.75128, 0.75784, 0.76433, 0.77074, 0.77707, 0.78333, 0.78950, 0.79560, 0.80162, 0.80756, 0.81342, 0.81919, 0.82489, 0.83050, 0.83603, 0.84147, 0.84683, 0.85211, 0.85730, 0.86240, 0.86742, 0.87236, 0.87720, 0.88196, 0.88663, 0.89121, 0.89570, 0.90010, 0.90441, 0.90863, 0.91276, 0.91680, 0.92075, 0.92461, 0.92837, 0.93204, 0.93562, 0.93910, 0.94249, 0.94578, 0.94898, 0.95209, 0.95510, 0.95802, 0.96084, 0.96356, 0.96618, 0.96872, 0.97115, 0.97348, 0.97572, 0.97786, 0.97991, 0.98185, 0.98370, 0.98545, 0.98710, 0.98865, 0.99010, 0.99146, 0.99271, 0.99387, 0.99492, 0.99588, 0.99674, 0.99749, 0.99815, 0.99871, 0.99917, 0.99953, 0.99978, 0.99994, 1.00000, 0.99996, 0.99982, 0.99957, 0.99923, 0.99879, 0.99825, 0.99761, 0.99687, 0.99602, 0.99508, 0.99404, 0.99290, 0.99166, 0.99033, 0.98889, 0.98735, 0.98572, 0.98399, 0.98215, 0.98022, 0.97820, 0.97607, 0.97385, 0.97153, 0.96911, 0.96659, 0.96398, 0.96128, 0.95847, 0.95557, 0.95258, 0.94949, 0.94630, 0.94302, 0.93965, 0.93618, 0.93262, 0.92896, 0.92521, 0.92137, 0.91744, 0.91341, 0.90930, 0.90509, 0.90079, 0.89641, 0.89193, 0.88736, 0.88271, 0.87796, 0.87313, 0.86821, 0.86321, 0.85812, 0.85294, 0.84768, 0.84233, 0.83690, 0.83138, 0.82578, 0.82010, 0.81434, 0.80850, 0.80257, 0.79657, 0.79048, 0.78432, 0.77807, 0.77175, 0.76535, 0.75888, 0.75233, 0.74571, 0.73901, 0.73223, 0.72538, 0.71846, 0.71147, 0.70441, 0.69728, 0.69007, 0.68280, 0.67546, 0.66806, 0.66058, 0.65304, 0.64543, 0.63776, 0.63003, 0.62223, 0.61437, 0.60645, 0.59847, 0.59043, 0.58233, 0.57417, 0.56596, 0.55768, 0.54936, 0.54097, 0.53253, 0.52404, 0.51550, 0.50691, 0.49826, 0.48957, 0.48082, 0.47203, 0.46319, 0.45431, 0.44537, 0.43640, 0.42738, 0.41832, 0.40921, 0.40007, 0.39088, 0.38166, 0.37240, 0.36310, 0.35376, 0.34439, 0.33499, 0.32555, 0.31608, 0.30657, 0.29704, 0.28748, 0.27789, 0.26827, 0.25862, 0.24895, 0.23925, 0.22953, 0.21978, 0.21002, 0.20023, 0.19042, 0.18060, 0.17075, 0.16089, 0.15101, 0.14112, 0.13121, 0.12129, 0.11136, 0.10142, 0.09146, 0.08150, 0.07153, 0.06155, 0.05157, 0.04158, 0.03159, 0.02159, 0.01159, 0.00159, -0.00841,
        -0.01841, -0.02840, -0.03840, -0.04839, -0.05837, -0.06835, -0.07833, -0.08829, -0.09825, -0.10820, -0.11813, -0.12805, -0.13797, -0.14786, -0.15775, -0.16761, -0.17746, -0.18729, -0.19711, -0.20690, -0.21668, -0.22643, -0.23616, -0.24586, -0.25554, -0.26520, -0.27482, -0.28443, -0.29400, -0.30354, -0.31305, -0.32254, -0.33199, -0.34140, -0.35078, -0.36013, -0.36944, -0.37871, -0.38795, -0.39715, -0.40631, -0.41542, -0.42450, -0.43353, -0.44252, -0.45147, -0.46037, -0.46922, -0.47803, -0.48679, -0.49550, -0.50416, -0.51277, -0.52133, -0.52984, -0.53829, -0.54669, -0.55504, -0.56333, -0.57156, -0.57974, -0.58786, -0.59592, -0.60392, -0.61186, -0.61974, -0.62755, -0.63531, -0.64300, -0.65063, -0.65819, -0.66568, -0.67311, -0.68047, -0.68777, -0.69499, -0.70215, -0.70923, -0.71625, -0.72319, -0.73006, -0.73686, -0.74358, -0.75023, -0.75680, -0.76330, -0.76972, -0.77607, -0.78234, -0.78853, -0.79464, -0.80067, -0.80662, -0.81249, -0.81828, -0.82398, -0.82961, -0.83515, -0.84061, -0.84598, -0.85127, -0.85648, -0.86160, -0.86663, -0.87158, -0.87643, -0.88121, -0.88589, -0.89048, -0.89499, -0.89941, -0.90373, -0.90797, -0.91211, -0.91617, -0.92013, -0.92400, -0.92778, -0.93146, -0.93505, -0.93855, -0.94196, -0.94527, -0.94848, -0.95160, -0.95463, -0.95756, -0.96039, -0.96313, -0.96577, -0.96832, -0.97077, -0.97312, -0.97537, -0.97753, -0.97959, -0.98155, -0.98341, -0.98518, -0.98684, -0.98841, -0.98988, -0.99125, -0.99252, -0.99369, -0.99476, -0.99574, -0.99661, -0.99738, -0.99805, -0.99863, -0.99910, -0.99948, -0.99975, -0.99992, -1.00000, -0.99997, -0.99984, -0.99962, -0.99929, -0.99887, -0.99834, -0.99772, -0.99699, -0.99616, -0.99524, -0.99422, -0.99309, -0.99187, -0.99055, -0.98913, -0.98761, -0.98599, -0.98427, -0.98245, -0.98054, -0.97853, -0.97642, -0.97421, -0.97190, -0.96950, -0.96700, -0.96441, -0.96171, -0.95892, -0.95604, -0.95306, -0.94998, -0.94681, -0.94355, -0.94019, -0.93674, -0.93319, -0.92955, -0.92581, -0.92199, -0.91807, -0.91406, -0.90996, -0.90577, -0.90148, -0.89711, -0.89265, -0.88810, -0.88345, -0.87873, -0.87391, -0.86900, -0.86401, -0.85893, -0.85377, -0.84852, -0.84319, -0.83777, -0.83227, -0.82668, -0.82101, -0.81526, -0.80943, -0.80352, -0.79753, -0.79145, -0.78530, -0.77907, -0.77276, -0.76638, -0.75992, -0.75338, -0.74677, -0.74008, -0.73332, -0.72648, -0.71957, -0.71259, -0.70554, -0.69842, -0.69123, -0.68397, -0.67664, -0.66924, -0.66178, -0.65425, -0.64665, -0.63899, -0.63127, -0.62348, -0.61563, -0.60772, -0.59975, -0.59172, -0.58362, -0.57548, -0.56727, -0.55900, -0.55069, -0.54231, -0.53388, -0.52540, -0.51687, -0.50828, -0.49964, -0.49095, -0.48222, -0.47343, -0.46460, -0.45572, -0.44680, -0.43783, -0.42882, -0.41976, -0.41067, -0.40153, -0.39235, -0.38313, -0.37388, -0.36458, -0.35525, -0.34589, -0.33649, -0.32705, -0.31759, -0.30809, -0.29856, -0.28900, -0.27942, -0.26980, -0.26016, -0.25049, -0.24080, -0.23108, -0.22134, -0.21157, -0.20179, -0.19199, -0.18216, -0.17232, -0.16246, -0.15259, -0.14270, -0.13279, -0.12287, -0.11294, -0.10300, -0.09305, -0.08309, -0.07312, -0.06314, -0.05316, -0.04317, -0.03318, -0.02318, -0.01318, -0.00319 };
double sin_lookup(double a)
{
    int b = (int)(a * 100);

    if (absd(b) >= SIN_LOOKUP_TABLE_MAX_SIZE) return sin(a);

    if (b < 0) return -1 * sin_lookup_table[-1 * b];

    return sin_lookup_table[b];
}

#define COS_LOOKUP_TABLE_MAX_SIZE 629
double cos_lookup_table[COS_LOOKUP_TABLE_MAX_SIZE] = {
        1.00000, 0.99995, 0.99980, 0.99955, 0.99920, 0.99875, 0.99820, 0.99755, 0.99680, 0.99595, 0.99500, 0.99396, 0.99281, 0.99156, 0.99022, 0.98877, 0.98723, 0.98558, 0.98384, 0.98200, 0.98007, 0.97803, 0.97590, 0.97367, 0.97134, 0.96891, 0.96639, 0.96377, 0.96106, 0.95824, 0.95534, 0.95233, 0.94924, 0.94604, 0.94275, 0.93937, 0.93590, 0.93233, 0.92866, 0.92491, 0.92106, 0.91712, 0.91309, 0.90897, 0.90475, 0.90045, 0.89605, 0.89157, 0.88699, 0.88233, 0.87758, 0.87274, 0.86782, 0.86281, 0.85771, 0.85252, 0.84726, 0.84190, 0.83646, 0.83094, 0.82534, 0.81965, 0.81388, 0.80803, 0.80210, 0.79608, 0.78999, 0.78382, 0.77757, 0.77125, 0.76484, 0.75836, 0.75181, 0.74517, 0.73847, 0.73169, 0.72484, 0.71791, 0.71091, 0.70385, 0.69671, 0.68950, 0.68222, 0.67488, 0.66746, 0.65998, 0.65244, 0.64483, 0.63715, 0.62941, 0.62161, 0.61375, 0.60582, 0.59783, 0.58979, 0.58168, 0.57352, 0.56530, 0.55702, 0.54869, 0.54030, 0.53186, 0.52337, 0.51482, 0.50622, 0.49757, 0.48887, 0.48012, 0.47133, 0.46249, 0.45360, 0.44466, 0.43568, 0.42666, 0.41759, 0.40849, 0.39934, 0.39015, 0.38092, 0.37166, 0.36236, 0.35302, 0.34365, 0.33424, 0.32480, 0.31532, 0.30582, 0.29628, 0.28672, 0.27712, 0.26750, 0.25785, 0.24818, 0.23848, 0.22875, 0.21901, 0.20924, 0.19945, 0.18964, 0.17981, 0.16997, 0.16010, 0.15023, 0.14033, 0.13042, 0.12050, 0.11057, 0.10063, 0.09067, 0.08071, 0.07074, 0.06076, 0.05077, 0.04079, 0.03079, 0.02079, 0.01080, 0.00080,
        -0.00920, -0.01920, -0.02920, -0.03919, -0.04918, -0.05917, -0.06915, -0.07912, -0.08909, -0.09904, -0.10899, -0.11892, -0.12884, -0.13875, -0.14865, -0.15853, -0.16840, -0.17825, -0.18808, -0.19789, -0.20768, -0.21745, -0.22720, -0.23693, -0.24663, -0.25631, -0.26596, -0.27559, -0.28519, -0.29476, -0.30430, -0.31381, -0.32329, -0.33274, -0.34215, -0.35153, -0.36087, -0.37018, -0.37945, -0.38868, -0.39788, -0.40703, -0.41615, -0.42522, -0.43425, -0.44323, -0.45218, -0.46107, -0.46992, -0.47873, -0.48748, -0.49619, -0.50485, -0.51345, -0.52201, -0.53051, -0.53896, -0.54736, -0.55570, -0.56399, -0.57221, -0.58039, -0.58850, -0.59656, -0.60455, -0.61249, -0.62036, -0.62817, -0.63592, -0.64361, -0.65123, -0.65879, -0.66628, -0.67370, -0.68106, -0.68834, -0.69556, -0.70271, -0.70979, -0.71680, -0.72374, -0.73060, -0.73739, -0.74411, -0.75075, -0.75732, -0.76382, -0.77023, -0.77657, -0.78283, -0.78901, -0.79512, -0.80114, -0.80709, -0.81295, -0.81873, -0.82444, -0.83005, -0.83559, -0.84104, -0.84641, -0.85169, -0.85689, -0.86200, -0.86703, -0.87197, -0.87682, -0.88158, -0.88626, -0.89085, -0.89534, -0.89975, -0.90407, -0.90830, -0.91244, -0.91648, -0.92044, -0.92430, -0.92807, -0.93175, -0.93533, -0.93883, -0.94222, -0.94553, -0.94873, -0.95185, -0.95486, -0.95779, -0.96061, -0.96334, -0.96598, -0.96852, -0.97096, -0.97330, -0.97555, -0.97770, -0.97975, -0.98170, -0.98356, -0.98531, -0.98697, -0.98853, -0.98999, -0.99135, -0.99262, -0.99378, -0.99484, -0.99581, -0.99667, -0.99744, -0.99810, -0.99867, -0.99914, -0.99950, -0.99977, -0.99993, -1.00000, -0.99996,
        -0.99983, -0.99960, -0.99926, -0.99883, -0.99829, -0.99766, -0.99693, -0.99609, -0.99516, -0.99413, -0.99300, -0.99177, -0.99044, -0.98901, -0.98748, -0.98585, -0.98413, -0.98230, -0.98038, -0.97836, -0.97624, -0.97403, -0.97172, -0.96931, -0.96680, -0.96419, -0.96149, -0.95870, -0.95581, -0.95282, -0.94974, -0.94656, -0.94328, -0.93992, -0.93646, -0.93290, -0.92925, -0.92551, -0.92168, -0.91775, -0.91374, -0.90963, -0.90543, -0.90114, -0.89676, -0.89229, -0.88773, -0.88308, -0.87835, -0.87352, -0.86861, -0.86361, -0.85853, -0.85336, -0.84810, -0.84276, -0.83733, -0.83183, -0.82623, -0.82056, -0.81480, -0.80896, -0.80305, -0.79705, -0.79097, -0.78481, -0.77857, -0.77226, -0.76587, -0.75940, -0.75285, -0.74624, -0.73954, -0.73277, -0.72593, -0.71902, -0.71203, -0.70498, -0.69785, -0.69065, -0.68338, -0.67605, -0.66865, -0.66118, -0.65364, -0.64604, -0.63838, -0.63065, -0.62286, -0.61500, -0.60709, -0.59911, -0.59107, -0.58298, -0.57482, -0.56661, -0.55834, -0.55002, -0.54164, -0.53321, -0.52472, -0.51618, -0.50759, -0.49895, -0.49026, -0.48152, -0.47273, -0.46390, -0.45501, -0.44609, -0.43712, -0.42810, -0.41904, -0.40994, -0.40080, -0.39162, -0.38240, -0.37314, -0.36384, -0.35451, -0.34514, -0.33574, -0.32630, -0.31683, -0.30733, -0.29780, -0.28824, -0.27865, -0.26903, -0.25939, -0.24972, -0.24002, -0.23030, -0.22056, -0.21080, -0.20101, -0.19120, -0.18138, -0.17154, -0.16168, -0.15180, -0.14191, -0.13200, -0.12208, -0.11215, -0.10221, -0.09226, -0.08230, -0.07233, -0.06235, -0.05237, -0.04238, -0.03238, -0.02239, -0.01239, -0.00239,        0.00761,
        0.01761, 0.02761, 0.03760, 0.04759, 0.05758, 0.06756, 0.07753, 0.08750, 0.09746, 0.10740, 0.11734, 0.12726, 0.13718, 0.14708, 0.15696, 0.16683, 0.17668, 0.18651, 0.19633, 0.20612, 0.21590, 0.22565, 0.23538, 0.24509, 0.25477, 0.26443, 0.27406, 0.28366, 0.29324, 0.30278, 0.31230, 0.32178, 0.33123, 0.34065, 0.35004, 0.35939, 0.36870, 0.37798, 0.38722, 0.39642, 0.40558, 0.41470, 0.42378, 0.43281, 0.44181, 0.45076, 0.45966, 0.46852, 0.47733, 0.48609, 0.49481, 0.50347, 0.51209, 0.52065, 0.52916, 0.53762, 0.54602, 0.55437, 0.56267, 0.57091, 0.57909, 0.58721, 0.59528, 0.60328, 0.61123, 0.61911, 0.62693, 0.63469, 0.64239, 0.65002, 0.65759, 0.66509, 0.67252, 0.67989, 0.68719, 0.69442, 0.70158, 0.70867, 0.71569, 0.72264, 0.72951, 0.73632, 0.74305, 0.74970, 0.75628, 0.76279, 0.76921, 0.77557, 0.78184, 0.78804, 0.79415, 0.80019, 0.80615, 0.81202, 0.81782, 0.82353, 0.82916, 0.83471, 0.84018, 0.84556, 0.85086, 0.85607, 0.86119, 0.86623, 0.87119, 0.87605, 0.88083, 0.88552, 0.89012, 0.89463, 0.89906, 0.90339, 0.90763, 0.91179, 0.91585, 0.91982, 0.92369, 0.92748, 0.93117, 0.93477, 0.93828, 0.94169, 0.94501, 0.94823, 0.95136, 0.95439, 0.95733, 0.96017, 0.96292, 0.96557, 0.96812, 0.97058, 0.97294, 0.97520, 0.97736, 0.97943, 0.98140, 0.98327, 0.98504, 0.98671, 0.98829, 0.98977, 0.99114, 0.99242, 0.99360, 0.99468, 0.99566, 0.99654, 0.99732, 0.99800, 0.99859, 0.99907, 0.99945, 0.99973, 0.99991, 0.99999 };
double cos_lookup(double a)
{
    int b = (int)(a * 100);

    if (absd(b) >= COS_LOOKUP_TABLE_MAX_SIZE) return cos(a);

    if (b < 0) return cos_lookup_table[-1 * b];

    return cos_lookup_table[b];
}

#define ACOS_LOOKUP_TABLE_MAX_SIZE 1000
double acos_lookup_table[ACOS_LOOKUP_TABLE_MAX_SIZE] = {
        1.56980, 1.56880, 1.56780, 1.56680, 1.56580, 1.56480, 1.56380, 1.56280, 1.56180, 1.56080, 1.55980, 1.55880, 1.55780, 1.55680, 1.55580, 1.55480, 1.55380, 1.55280, 1.55180, 1.55079, 1.54979, 1.54879, 1.54779, 1.54679, 1.54579, 1.54479, 1.54379, 1.54279, 1.54179, 1.54079, 1.53979, 1.53879, 1.53779, 1.53679, 1.53579, 1.53479, 1.53379, 1.53279, 1.53179, 1.53079, 1.52978, 1.52878, 1.52778, 1.52678, 1.52578, 1.52478, 1.52378, 1.52278, 1.52178, 1.52078, 1.51977, 1.51877, 1.51777, 1.51677, 1.51577, 1.51477, 1.51377, 1.51276, 1.51176, 1.51076, 1.50976, 1.50876, 1.50775, 1.50675, 1.50575, 1.50475, 1.50375, 1.50274, 1.50174, 1.50074, 1.49974, 1.49873, 1.49773, 1.49673, 1.49573, 1.49472, 1.49372, 1.49272, 1.49171, 1.49071, 1.48971, 1.48870, 1.48770, 1.48670, 1.48569, 1.48469, 1.48369, 1.48268, 1.48168, 1.48067, 1.47967, 1.47867, 1.47766, 1.47666, 1.47565, 1.47465, 1.47364, 1.47264, 1.47163, 1.47063, 1.46962, 1.46862, 1.46761, 1.46661, 1.46560, 1.46460, 1.46359, 1.46259, 1.46158, 1.46057, 1.45957, 1.45856, 1.45755, 1.45655, 1.45554, 1.45453, 1.45353, 1.45252, 1.45151, 1.45051, 1.44950, 1.44849, 1.44748, 1.44648, 1.44547, 1.44446, 1.44345, 1.44244, 1.44144, 1.44043, 1.43942, 1.43841, 1.43740, 1.43639, 1.43538, 1.43437, 1.43336, 1.43235, 1.43134, 1.43033, 1.42932, 1.42831, 1.42730, 1.42629, 1.42528, 1.42427, 1.42326, 1.42225, 1.42124, 1.42023, 1.41922, 1.41820, 1.41719, 1.41618, 1.41517, 1.41416, 1.41314, 1.41213, 1.41112, 1.41011, 1.40909, 1.40808, 1.40707, 1.40605, 1.40504, 1.40402, 1.40301, 1.40200, 1.40098, 1.39997, 1.39895, 1.39794, 1.39692, 1.39591, 1.39489, 1.39387, 1.39286, 1.39184, 1.39083, 1.38981, 1.38879, 1.38778, 1.38676, 1.38574, 1.38472, 1.38371, 1.38269, 1.38167, 1.38065, 1.37963, 1.37862, 1.37760, 1.37658, 1.37556, 1.37454, 1.37352, 1.37250, 1.37148, 1.37046, 1.36944, 1.36842, 1.36740, 1.36638, 1.36535, 1.36433, 1.36331, 1.36229, 1.36127, 1.36024, 1.35922, 1.35820, 1.35718, 1.35615, 1.35513, 1.35410, 1.35308, 1.35206, 1.35103, 1.35001, 1.34898, 1.34796, 1.34693, 1.34591, 1.34488, 1.34385, 1.34283, 1.34180, 1.34077, 1.33975, 1.33872, 1.33769, 1.33666, 1.33563, 1.33461, 1.33358, 1.33255, 1.33152, 1.33049, 1.32946, 1.32843, 1.32740, 1.32637, 1.32534, 1.32431, 1.32328, 1.32225, 1.32121, 1.32018, 1.31915, 1.31812, 1.31708, 1.31605, 1.31502, 1.31398, 1.31295, 1.31191, 1.31088, 1.30984, 1.30881, 1.30777, 1.30674, 1.30570, 1.30467, 1.30363, 1.30259, 1.30156, 1.30052, 1.29948, 1.29844, 1.29740, 1.29636, 1.29533, 1.29429, 1.29325, 1.29221, 1.29117, 1.29013, 1.28908, 1.28804, 1.28700, 1.28596, 1.28492, 1.28388, 1.28283, 1.28179, 1.28075, 1.27970, 1.27866, 1.27761, 1.27657, 1.27552, 1.27448, 1.27343, 1.27239, 1.27134, 1.27029, 1.26925, 1.26820, 1.26715, 1.26610, 1.26506, 1.26401, 1.26296, 1.26191, 1.26086, 1.25981, 1.25876, 1.25771, 1.25665, 1.25560, 1.25455, 1.25350, 1.25245, 1.25139, 1.25034, 1.24929, 1.24823, 1.24718, 1.24612, 1.24507, 1.24401, 1.24296, 1.24190, 1.24084, 1.23978, 1.23873, 1.23767, 1.23661, 1.23555, 1.23449, 1.23343, 1.23237, 1.23131, 1.23025, 1.22919, 1.22813, 1.22707, 1.22601, 1.22494, 1.22388, 1.22282, 1.22175, 1.22069, 1.21962, 1.21856, 1.21749, 1.21643, 1.21536, 1.21429, 1.21323, 1.21216, 1.21109, 1.21002, 1.20895, 1.20788, 1.20681, 1.20574, 1.20467, 1.20360, 1.20253, 1.20146, 1.20038, 1.19931, 1.19824, 1.19716, 1.19609, 1.19501, 1.19394, 1.19286, 1.19179, 1.19071, 1.18963, 1.18856, 1.18748, 1.18640, 1.18532, 1.18424, 1.18316, 1.18208, 1.18100, 1.17992, 1.17884, 1.17775, 1.17667, 1.17559, 1.17450, 1.17342, 1.17234, 1.17125, 1.17016, 1.16908, 1.16799, 1.16690, 1.16582, 1.16473, 1.16364, 1.16255, 1.16146, 1.16037, 1.15928, 1.15819, 1.15710, 1.15600, 1.15491, 1.15382, 1.15272, 1.15163, 1.15053, 1.14944, 1.14834, 1.14725, 1.14615, 1.14505, 1.14395, 1.14285, 1.14175, 1.14065, 1.13955, 1.13845, 1.13735, 1.13625, 1.13515, 1.13404, 1.13294, 1.13183, 1.13073, 1.12962, 1.12852, 1.12741, 1.12630, 1.12520, 1.12409, 1.12298, 1.12187, 1.12076, 1.11965, 1.11854, 1.11742, 1.11631, 1.11520, 1.11408, 1.11297, 1.11185, 1.11074, 1.10962, 1.10851, 1.10739, 1.10627, 1.10515, 1.10403, 1.10291, 1.10179, 1.10067, 1.09955, 1.09842, 1.09730, 1.09618, 1.09505, 1.09393, 1.09280, 1.09167, 1.09055, 1.08942, 1.08829, 1.08716, 1.08603, 1.08490, 1.08377, 1.08264, 1.08151, 1.08037, 1.07924, 1.07810, 1.07697, 1.07583, 1.07470, 1.07356, 1.07242, 1.07128, 1.07014, 1.06900, 1.06786, 1.06672, 1.06558, 1.06443, 1.06329, 1.06214, 1.06100, 1.05985, 1.05871, 1.05756, 1.05641, 1.05526, 1.05411, 1.05296, 1.05181, 1.05066, 1.04951, 1.04835, 1.04720, 1.04604, 1.04489, 1.04373, 1.04257, 1.04141, 1.04026, 1.03910, 1.03794, 1.03677, 1.03561, 1.03445, 1.03328, 1.03212, 1.03095, 1.02979, 1.02862, 1.02745, 1.02629, 1.02512, 1.02395, 1.02277, 1.02160, 1.02043, 1.01926, 1.01808, 1.01691, 1.01573, 1.01455, 1.01337, 1.01220, 1.01102, 1.00984, 1.00865, 1.00747, 1.00629, 1.00510, 1.00392, 1.00273, 1.00155, 1.00036, 0.99917, 0.99798, 0.99679, 0.99560, 0.99441, 0.99321, 0.99202, 0.99082, 0.98963, 0.98843, 0.98723, 0.98604, 0.98484, 0.98364, 0.98243, 0.98123, 0.98003, 0.97882, 0.97762, 0.97641, 0.97520, 0.97399, 0.97279, 0.97157, 0.97036, 0.96915, 0.96794, 0.96672, 0.96551, 0.96429, 0.96307, 0.96185, 0.96063, 0.95941, 0.95819, 0.95697, 0.95575, 0.95452, 0.95329, 0.95207, 0.95084, 0.94961, 0.94838, 0.94715, 0.94592, 0.94468, 0.94345, 0.94221, 0.94098, 0.93974, 0.93850, 0.93726, 0.93602, 0.93477, 0.93353, 0.93229, 0.93104, 0.92979, 0.92854, 0.92730, 0.92604, 0.92479, 0.92354, 0.92229, 0.92103, 0.91977, 0.91852, 0.91726, 0.91600, 0.91474, 0.91347, 0.91221, 0.91094, 0.90968, 0.90841, 0.90714, 0.90587, 0.90460, 0.90333, 0.90205, 0.90078, 0.89950, 0.89822, 0.89695, 0.89566, 0.89438, 0.89310, 0.89182, 0.89053, 0.88924, 0.88795, 0.88667, 0.88537, 0.88408, 0.88279, 0.88149, 0.88020, 0.87890, 0.87760, 0.87630, 0.87500, 0.87369, 0.87239, 0.87108, 0.86977, 0.86846, 0.86715, 0.86584, 0.86453, 0.86321, 0.86190, 0.86058, 0.85926, 0.85794, 0.85661, 0.85529, 0.85396, 0.85264, 0.85131, 0.84998, 0.84865, 0.84731, 0.84598, 0.84464, 0.84330, 0.84196, 0.84062, 0.83928, 0.83793, 0.83659, 0.83524, 0.83389, 0.83254, 0.83119, 0.82983, 0.82848, 0.82712, 0.82576, 0.82440, 0.82303, 0.82167, 0.82030, 0.81893, 0.81756, 0.81619, 0.81482, 0.81344, 0.81207, 0.81069, 0.80931, 0.80792, 0.80654, 0.80515, 0.80377, 0.80238, 0.80098, 0.79959, 0.79820, 0.79680, 0.79540, 0.79400, 0.79259, 0.79119, 0.78978, 0.78837, 0.78696, 0.78555, 0.78413, 0.78272, 0.78130, 0.77988, 0.77845, 0.77703, 0.77560, 0.77417, 0.77274, 0.77131, 0.76987, 0.76843, 0.76699, 0.76555, 0.76411, 0.76266, 0.76121, 0.75976, 0.75831, 0.75685, 0.75540, 0.75394, 0.75247, 0.75101, 0.74954, 0.74807, 0.74660, 0.74513, 0.74365, 0.74218, 0.74069, 0.73921, 0.73773, 0.73624, 0.73475, 0.73325, 0.73176, 0.73026, 0.72876, 0.72726, 0.72575, 0.72424, 0.72273, 0.72122, 0.71971, 0.71819, 0.71667, 0.71514, 0.71362, 0.71209, 0.71055, 0.70902, 0.70748, 0.70594, 0.70440, 0.70285, 0.70131, 0.69975, 0.69820, 0.69664, 0.69508, 0.69352, 0.69196, 0.69039, 0.68881, 0.68724, 0.68566, 0.68408, 0.68250, 0.68091, 0.67932, 0.67773, 0.67613, 0.67453, 0.67293, 0.67132, 0.66971, 0.66810, 0.66648, 0.66487, 0.66324, 0.66162, 0.65999, 0.65835, 0.65672, 0.65508, 0.65344, 0.65179, 0.65014, 0.64848, 0.64683, 0.64517, 0.64350, 0.64183, 0.64016, 0.63848, 0.63680, 0.63512, 0.63343, 0.63174, 0.63005, 0.62835, 0.62664, 0.62494, 0.62323, 0.62151, 0.61979, 0.61807, 0.61634, 0.61461, 0.61287, 0.61113, 0.60939, 0.60764, 0.60588, 0.60412, 0.60236, 0.60059, 0.59882, 0.59705, 0.59526, 0.59348, 0.59169, 0.58989, 0.58809, 0.58629, 0.58448, 0.58266, 0.58084, 0.57902, 0.57719, 0.57535, 0.57351, 0.57167, 0.56982, 0.56796, 0.56610, 0.56423, 0.56236, 0.56048, 0.55860, 0.55671, 0.55481, 0.55291, 0.55100, 0.54909, 0.54717, 0.54525, 0.54331, 0.54138, 0.53943, 0.53748, 0.53553, 0.53356, 0.53159, 0.52962, 0.52764, 0.52565, 0.52365, 0.52165, 0.51964, 0.51762, 0.51559, 0.51356, 0.51152, 0.50948, 0.50742, 0.50536, 0.50329, 0.50121, 0.49913, 0.49704, 0.49493, 0.49282, 0.49071, 0.48858, 0.48645, 0.48430, 0.48215, 0.47999, 0.47782, 0.47564, 0.47345, 0.47125, 0.46905, 0.46683, 0.46460, 0.46237, 0.46012, 0.45786, 0.45559, 0.45332, 0.45103, 0.44873, 0.44642, 0.44409, 0.44176, 0.43942, 0.43706, 0.43469, 0.43231, 0.42992, 0.42751, 0.42509, 0.42266, 0.42022, 0.41776, 0.41529, 0.41280, 0.41030, 0.40779, 0.40526, 0.40272, 0.40016, 0.39758, 0.39499, 0.39238, 0.38976, 0.38712, 0.38446, 0.38179, 0.37909, 0.37638, 0.37365, 0.37090, 0.36814, 0.36535, 0.36254, 0.35971, 0.35686, 0.35398, 0.35109, 0.34817, 0.34522, 0.34226, 0.33926, 0.33625, 0.33320, 0.33013, 0.32703, 0.32390, 0.32075, 0.31756, 0.31434, 0.31109, 0.30781, 0.30449, 0.30114, 0.29775, 0.29432, 0.29085, 0.28734, 0.28379, 0.28020, 0.27656, 0.27288, 0.26914, 0.26535, 0.26151, 0.25762, 0.25366, 0.24965, 0.24557, 0.24142, 0.23720, 0.23291, 0.22853, 0.22408, 0.21953, 0.21489, 0.21015, 0.20530, 0.20033, 0.19525, 0.19002, 0.18465, 0.17912, 0.17342, 0.16753, 0.16142, 0.15507, 0.14846, 0.14154, 0.13426, 0.12658, 0.11839, 0.10960, 0.10004, 0.08947, 0.07748, 0.06326, 0.04473, 0.00000 };
double acos_lookup(double a)
{
    int b = (int)(a * 1000);

    if (absd(b) >= ACOS_LOOKUP_TABLE_MAX_SIZE) return acos(a);

    if (b < 0) return M_2X_PI - acos_lookup_table[-1 * b];

    return acos_lookup_table[b];
}

double calculateEMA(double currentValue, long numberOfSamples, double lastEMA)
{
    double k = 2 / ((double)numberOfSamples + 1);
    return currentValue * k + lastEMA * (1 - k);
}
